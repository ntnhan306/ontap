<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Giao b√†i t·∫≠p</title>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #74ebd5, #acb6e5);
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
  }
  .container {
    width: 90%;
    max-width: 900px;
    background: #fff;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }
  .toolbar {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 15px;
    gap: 10px;
  }
  button {
    border: none;
    background: #4e54c8;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover { background: #6c63ff; transform: scale(1.05); }
  select, input, textarea {
    width: 100%;
    margin-top: 5px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  .section { margin-bottom: 20px; }
  .optionItem { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .preview {
    background: #f3f4f6;
    border-radius: 15px;
    padding: 15px;
    margin-top: 20px;
  }
  .preview-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .preview-options > div {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 5px;
    padding: 10px 4px;
  }
  .preview-options > div:hover {
    background: #e5e7eb;
    border-radius: 8px;
  }
  .preview-options input[type="radio"],
  .preview-options input[type="checkbox"] {
    width: fit-content;
    height: fit-content;
    margin: 0;
    padding: 0;
  }
  .studentView {
    background: rgba(0,0,0,0.6);
    position: fixed;
    top:0;left:0;width:100%;height:100%;
    display: none;
    justify-content: center;
    align-items: center;
  }
  .studentInner {
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <button id="newBtn">T·∫°o b√†i m·ªõi</button>
      <button id="previewBtn">Xem tr∆∞·ªõc</button>
      <button id="sendBtn">Giao b√†i</button>
      <button id="seeStudentBtn">Xem m√†n h√¨nh h·ªçc sinh</button>
      <button id="cancelBtn">Hu·ª∑ b√†i</button>
    </div>

    <div class="section">
      <label><b>C√¢u h·ªèi:</b></label>
      <textarea id="question" rows="3" placeholder="Nh·∫≠p c√¢u h·ªèi..."></textarea>
    </div>

    <div class="section">
      <label><b>Lo·∫°i c√¢u h·ªèi:</b></label>
      <select id="type">
        <option value="tracnghiem">Tr·∫Øc nghi·ªám (1 ƒë√°p √°n)</option>
        <option value="chonnhieu">Ch·ªçn nhi·ªÅu ƒë√°p √°n</option>
        <option value="dienvao">ƒêi·ªÅn v√†o ch·ªó tr·ªëng</option>
        <option value="ngan">Tr·∫£ l·ªùi ng·∫Øn</option>
        <option value="doanvan">ƒêo·∫°n vƒÉn</option>
      </select>
    </div>

    <div id="answerArea"></div>

    <div class="preview">
      <h3>Xem tr∆∞·ªõc</h3>
      <div id="previewArea" style="padding:10px;">Ch∆∞a c√≥ n·ªôi dung</div>
    </div>
  </div>

  <!-- Khung xem m√†n h√¨nh h·ªçc sinh -->
  <div class="studentView" id="studentOverlay">
    <div class="studentInner">
      <button style="float:right;background:#ff4b5c;" id="closeOverlay">ƒê√≥ng</button>
      <h3>M√†n h√¨nh h·ªçc sinh</h3>
      <div id="studentScreen">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
    </div>
  </div>

  <script type="module">
    import { db } from "../firebase-config.js";
    import { ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const qEl = document.getElementById("question");
    const tEl = document.getElementById("type");
    const ansEl = document.getElementById("answerArea");
    const prevEl = document.getElementById("previewArea");
    const overlay = document.getElementById("studentOverlay");
    const studentScreen = document.getElementById("studentScreen");

    const btnNew = document.getElementById("newBtn");
    const btnPreview = document.getElementById("previewBtn");
    const btnSend = document.getElementById("sendBtn");
    const btnSeeStudent = document.getElementById("seeStudentBtn");
    const btnCancel = document.getElementById("cancelBtn");
    const btnClose = document.getElementById("closeOverlay");

    // --- Render ph·∫ßn nh·∫≠p ƒë√°p √°n ---
    function renderAnswerInputs() {
      let html = "";
      if (["tracnghiem", "chonnhieu"].includes(tEl.value)) {
        html += `<div id="optionsWrap"><button id="addOptBtn" type="button">+ Th√™m l·ª±a ch·ªçn</button><div id="optList"></div></div>`;
      } else {
        html += `<textarea id="correctText" rows="2" placeholder="ƒê√°p √°n ƒë√∫ng (n·∫øu c√≥)"></textarea>`;
      }
      ansEl.innerHTML = html;

      if (["tracnghiem", "chonnhieu"].includes(tEl.value)) {
        const addOpt = document.getElementById("addOptBtn");
        const optList = document.getElementById("optList");
        addOpt.onclick = () => {
          const isMulti = tEl.value === "chonnhieu";
          const div = document.createElement("div");
          div.className = "optionItem";
          div.innerHTML = `
            <input type="${isMulti ? "checkbox" : "radio"}" name="correctOpt" style="width: fit-content;">
            <input type="text" placeholder="N·ªôi dung l·ª±a ch·ªçn" class="optText" style="margin-left: 3px;">
            <button type="button" class="deleteBtn" onclick="this.parentElement.remove()" style="margin-left: auto; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">X√≥a</button>
          `;
          optList.appendChild(div);
        };
      }
    }
    tEl.onchange = renderAnswerInputs;
    renderAnswerInputs();

    // --- Xem tr∆∞·ªõc ---
    function updatePreview() {
      const q = qEl.value;
      const type = tEl.value;
      let html = `<h4>${q}</h4>`;
      if (["tracnghiem", "chonnhieu"].includes(type)) {
        html += `<div class="preview-options">`;
        const opts = document.querySelectorAll(".optText");
        opts.forEach(o => html += `<div><input type="${type==='tracnghiem'?'radio':'checkbox'}">${o.value}</div>`);
        html += `</div>`;
      } else {
        html += `<textarea placeholder="C√¢u tr·∫£ l·ªùi h·ªçc sinh..."></textarea>`;
      }
      prevEl.innerHTML = html;
    }

    qEl.oninput = updatePreview;
    ansEl.oninput = updatePreview;

    btnPreview.onclick = updatePreview;

    // --- Giao b√†i ---
    btnSend.onclick = () => {
      const q = qEl.value.trim();
      if (!q) return alert("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p c√¢u h·ªèi!");
      const type = tEl.value;
      const data = { question: q, type, options: [], correct: [] };
      if (["tracnghiem", "chonnhieu"].includes(type)) {
        const opts = document.querySelectorAll(".optText");
        const checks = document.querySelectorAll("input[name='correctOpt']");
        opts.forEach((o,i)=>{
          data.options.push(o.value);
          if (checks[i].checked) data.correct.push(i);
        });
      } else {
        data.correct = [document.getElementById("correctText")?.value || ""];
      }
      set(ref(db,"baiHienTai"), data);
      // alert("‚úÖ ƒê√£ giao b√†i cho h·ªçc sinh!");
    };

    // --- Hu·ª∑ b√†i ---
    btnCancel.onclick = ()=>{
      remove(ref(db,"baiHienTai"));
      alert("üõë ƒê√£ hu·ª∑ b√†i hi·ªán t·∫°i!");
    };

    // --- T·∫°o m·ªõi ---
    btnNew.onclick = ()=>location.reload();

    // --- Xem m√†n h√¨nh h·ªçc sinh ---
    btnSeeStudent.onclick = ()=>overlay.style.display="flex";
    btnClose.onclick = ()=>overlay.style.display="none";

    onValue(ref(db,"baiHienTai"), snap=>{
      const data = snap.val();
      if (!data) {
        studentScreen.innerHTML = "<p>Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c giao.</p>";
        return;
      }
      let html = `<h4>${data.question}</h4>`;
      if (["tracnghiem","chonnhieu"].includes(data.type)) {
        data.options.forEach((o,i)=>{
          html += `<div><input type="${data.type==='tracnghiem'?'radio':'checkbox'}"> ${o}</div>`;
        });
      } else {
        html += `<textarea rows="2" placeholder="C√¢u tr·∫£ l·ªùi h·ªçc sinh..."></textarea>`;
      }
      studentScreen.innerHTML = html;
    });
  </script>
</body>
</html>
